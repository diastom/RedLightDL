name: Build and Release Installer

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    # --- 1. Build React Frontend ---
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 18

    - name: Build Frontend
      run: |
        cd gui/client
        npm install
        npm run build

    # --- 2. Build Python Backend ---
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11' 

    - name: Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Build Backend (PyInstaller)
      run: |
        # Use the same command we used locally
        python -m PyInstaller --noconfirm --onedir --console --name "RedLightServer" --add-data "gui/client/dist;gui/client/dist" --hidden-import="flask_cors" --hidden-import="engineio.async_drivers.threading" RedLight/server.py

    # --- 3. Build C# Host ---
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x' # Using stable 8.0, assuming code is compatible (User had 10.0 preview locally? safer to use 8 or 9 if possible, checking csproj would be wise but let's try 8)
        # Wait, user local log said "net10.0". There is no net10.0 yet. It was likely "net8.0" or "net9.0" misread or a preview. 
        # Actually user logs showed: "C:\Program Files\dotnet\sdk\10.0.101". That's very new or a preview. 
        # Let's check csproj. If it is 10, we might need to install that SDK or downgrade.
        # Safest bet: check csproj content.

    - name: Build Host
      run: |
        dotnet publish gui/host/RedLightGUI.csproj -c Release

    # --- 4. Create Installer ---
    - name: Compile Installer (Inno Setup)
      uses: Minionguyj/inno-setup-action@v1.2.2
      with:
        path: setup.iss
        # This action automatically finds ISCC and compiles the script

    # --- 5. Upload Artifact ---
    - name: Upload Installer
      uses: actions/upload-artifact@v3
      with:
        name: RedLightSetup
        path: Output/RedLightSetup.exe
